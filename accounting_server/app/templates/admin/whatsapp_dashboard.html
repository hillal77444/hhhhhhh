{% extends "admin/base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>لوحة تحكم الواتساب</h2>
    
    <!-- حالة الخادم -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">حالة الخادم</h5>
        </div>
        <div class="card-body">
            <div id="server-status">
                {% if server_status.error %}
                    <div class="alert alert-danger">
                        {{ server_status.error }}
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        الخادم يعمل
                    </div>
                {% endif %}
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startSession()">بدء جلسة جديدة</button>
                <button class="btn btn-warning" onclick="restartSession()">إعادة تشغيل الجلسة</button>
                <button class="btn btn-danger" onclick="closeAllSessions()">إغلاق جميع الجلسات</button>
                <button class="btn btn-dark" onclick="killAllChrome()">إغلاق جميع صفحات كروم</button>
            </div>
        </div>
    </div>

    <!-- رمز QR -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">رمز QR</h5>
        </div>
        <div class="card-body text-center">
            <div id="qr-container">
                <p class="text-muted">اضغط على "بدء جلسة جديدة" لعرض رمز QR</p>
            </div>
        </div>
    </div>

    <!-- إرسال رسالة -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">إرسال رسالة</h5>
        </div>
        <div class="card-body">
            <form id="message-form">
                <div class="mb-3">
                    <label class="form-label">نوع الإرسال</label>
                    <select class="form-select" id="send-type" onchange="updateRecipients()">
                        <option value="single_user">مستخدم واحد</option>
                        <option value="multiple_users">عدة مستخدمين</option>
                        <option value="user_accounts">حسابات مستخدم</option>
                    </select>
                </div>

                <div id="single-user-section" class="mb-3">
                    <label class="form-label">اختر المستخدم</label>
                    <select class="form-select" id="single-user">
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.phone }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="multiple-users-section" class="mb-3" style="display: none;">
                    <label class="form-label">اختر المستخدمين</label>
                    <select class="form-select" id="multiple-users" multiple>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.phone }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="user-accounts-section" class="mb-3" style="display: none;">
                    <label class="form-label">اختر المستخدم</label>
                    <select class="form-select" id="user-accounts" onchange="loadUserAccounts()">
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                        {% endfor %}
                    </select>
                    <div id="accounts-list" class="mt-2"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">الرسالة</label>
                    <textarea class="form-control" id="message" rows="4" required></textarea>
                </div>

                <button type="submit" class="btn btn-primary">إرسال</button>
            </form>
        </div>
    </div>
</div>

<script>
let currentSession = null;

function updateRecipients() {
    const type = document.getElementById('send-type').value;
    document.getElementById('single-user-section').style.display = type === 'single_user' ? 'block' : 'none';
    document.getElementById('multiple-users-section').style.display = type === 'multiple_users' ? 'block' : 'none';
    document.getElementById('user-accounts-section').style.display = type === 'user_accounts' ? 'block' : 'none';
}

async function startSession() {
    try {
        const response = await fetch('/admin/whatsapp/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            currentSession = data.session;
            if (data.qr_available) {
                loadQRCode();
            }
            updateServerStatus();
        } else {
            alert('فشل في بدء الجلسة: ' + data.error);
        }
    } catch (error) {
        alert('خطأ في الاتصال بالخادم');
    }
}

async function restartSession() {
    if (!confirm('هل أنت متأكد من إعادة تشغيل الجلسة؟')) return;
    
    try {
        const response = await fetch('/admin/whatsapp/restart/admin_main', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            currentSession = data.data;
            if (data.data.qr_available) {
                loadQRCode();
            }
            updateServerStatus();
        } else {
            alert('فشل في إعادة تشغيل الجلسة: ' + data.error);
        }
    } catch (error) {
        alert('خطأ في الاتصال بالخادم');
    }
}

async function closeAllSessions() {
    if (!confirm('هل أنت متأكد من إغلاق جميع الجلسات؟')) return;
    
    try {
        const response = await fetch('/admin/whatsapp/close-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            currentSession = null;
            document.getElementById('qr-container').innerHTML = '<p class="text-muted">اضغط على "بدء جلسة جديدة" لعرض رمز QR</p>';
            updateServerStatus();
        } else {
            alert('فشل في إغلاق الجلسات: ' + data.error);
        }
    } catch (error) {
        alert('خطأ في الاتصال بالخادم');
    }
}

async function loadQRCode() {
    try {
        const response = await fetch('/admin/whatsapp/qr/admin_main');
        const qrContainer = document.getElementById('qr-container');
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            if (contentType.includes('image')) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                qrContainer.innerHTML = `<img src="${url}" alt="QR Code" style="max-width: 300px;">`;
            } else if (contentType.includes('text/html')) {
                const html = await response.text();
                qrContainer.innerHTML = html;
            }
        } else {
            qrContainer.innerHTML = '<p class="text-danger">فشل في تحميل رمز QR</p>';
        }
    } catch (error) {
        document.getElementById('qr-container').innerHTML = '<p class="text-danger">خطأ في الاتصال بالخادم</p>';
    }
}

async function updateServerStatus() {
    try {
        const response = await fetch('/admin/whatsapp/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('server-status');
        if (data.error) {
            statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    الخادم يعمل
                    <br>
                    عدد الجلسات النشطة: ${data.sessions.length}
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('server-status').innerHTML = '<div class="alert alert-danger">خطأ في الاتصال بالخادم</div>';
    }
}

async function loadUserAccounts() {
    const userId = document.getElementById('user-accounts').value;
    try {
        const response = await fetch(`/admin/user/${userId}/accounts`);
        const accounts = await response.json();
        
        const accountsList = document.getElementById('accounts-list');
        accountsList.innerHTML = accounts.map(account => `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${account.id}" id="account-${account.id}">
                <label class="form-check-label" for="account-${account.id}">
                    ${account.account_name} (${account.phone_number || 'لا يوجد رقم هاتف'})
                </label>
            </div>
        `).join('');
    } catch (error) {
        alert('خطأ في تحميل الحسابات');
    }
}

document.getElementById('message-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const type = document.getElementById('send-type').value;
    const message = document.getElementById('message').value;
    
    let data = {
        type: type,
        message: message
    };
    
    switch (type) {
        case 'single_user':
            data.user_id = document.getElementById('single-user').value;
            break;
        case 'multiple_users':
            data.user_ids = Array.from(document.getElementById('multiple-users').selectedOptions).map(option => option.value);
            break;
        case 'user_accounts':
            data.user_id = document.getElementById('user-accounts').value;
            data.account_ids = Array.from(document.querySelectorAll('#accounts-list input:checked')).map(input => input.value);
            break;
    }
    
    try {
        const response = await fetch('/admin/whatsapp/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.status === 'success' || result.status === 'queued') {
            alert('تم إرسال الرسالة بنجاح');
            document.getElementById('message').value = '';
        } else {
            alert('فشل في إرسال الرسالة: ' + result.error);
        }
    } catch (error) {
        alert('خطأ في الاتصال بالخادم');
    }
});

async function killAllChrome() {
    if (!confirm('هل أنت متأكد من إغلاق جميع صفحات كروم؟')) return;
    
    try {
        const response = await fetch('/admin/whatsapp/kill-chrome', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('تم إغلاق جميع صفحات كروم بنجاح');
            currentSession = null;
            document.getElementById('qr-container').innerHTML = '<p class="text-muted">اضغط على "بدء جلسة جديدة" لعرض رمز QR</p>';
            updateServerStatus();
        } else {
            alert('فشل في إغلاق صفحات كروم: ' + data.error);
        }
    } catch (error) {
        alert('خطأ في الاتصال بالخادم');
    }
}

// تحديث حالة الخادم كل 30 ثانية
setInterval(updateServerStatus, 30000);
// تحديث رمز QR كل 10 ثواني إذا كانت الجلسة نشطة
setInterval(() => {
    if (currentSession && currentSession.qr_available) {
        loadQRCode();
    }
}, 10000);
</script>
{% endblock %} 